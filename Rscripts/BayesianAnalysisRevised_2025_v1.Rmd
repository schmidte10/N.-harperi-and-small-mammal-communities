---
title: "N. harperi and small mammal communities"
author: "Elliott Schmidt"
date: "`r Sys.Date()`"
output: 
  html_document: 
    toc: true  
    toc_depth: 2
    toc_float: true
    code_folding: show
    collapse: no
    df_print: paged
    fig_caption: yes
    fig_height: 4
    fig_width: 6
    highlight: monochrome
    theme: cerulean
    latex_engine: xelatex
---

# Scenario 


# load libraries 

```{r warning=FALSE, message=FALSE}
library(tidyverse)
library(readxl) 
library(grid)
library(lubridate)
library(janitor)
library(brms)
library(rstan)
library(reshape2)
library(modelr)
library(emmeans)
library(bayestestR) 
library(tidybayes) 
library(patchwork) 
library(ggpubr)
library(cowplot)
library(HDInterval)
library(ggridges) 
library(DHARMa)
library(rphylopic)
library(ggeffects)
```

# Data import 

```{r warning=FALSE, message=FALSE}
orangemitedata_2020 <- read_delim("data/orangemitedata_2020.txt", 
                                  "\t", 
                                  escape_double = FALSE, 
                                  col_types = cols(Date = col_datetime(format = "%d/%m/%Y"),
                                                   Trapline = col_factor(levels = c("1","2", "3", "4","5", "7", "8","9")), 
                                                   Species = col_factor(levels = c("1","2", "3")), 
                                                   Sex = col_factor(levels = c("1","2")), 
                                                   Year = col_factor(levels = c("1","2", "3", "4"))), 
                                  trim_ws = TRUE)|>  
  rename(OrangeMites =`Orange Mites (Y/N)`)

smallmammaldata3 <- read_delim("data/smallmammaldata_v3.txt", 
                               "\t", 
                               escape_double = FALSE, 
                               col_types = cols(Date = col_date(format = "%Y-%m-%d"),
                                                Trapline = col_factor(levels = c("1","2", "3", "4", "5", "6", "7","8","9")),
                                                Species = col_factor(levels = c("1","2", "3")), 
                                                Sex = col_factor(levels = c("1","2")),
                                                Year = col_factor(levels = c("1","2", "3")), 
                                                X14 = col_skip(), 
                                                X15 = col_skip()), 
                               trim_ws = TRUE)|>  
  rename(OrangeMites =`Orange Mites (Y/N)`)

abund <- read_excel("data/smallmammaldata2016-2018_all.xlsx") 
abund_2020 <- read_delim("data/smallmammaldata2020_all.txt", 
                         "\t", escape_double = FALSE, col_types = cols(Date = col_date(format = "%d/%m/%Y")), 
                         trim_ws = TRUE) 
```

# Data manipulation 

```{r}
orangemitedata_v2 <- bind_rows(smallmammaldata3, orangemitedata_2020) |> 
  mutate(Trapline =factor(Trapline, levels =c('4','1','2','3','5','6','7','8','9')), 
         Species =factor(Species, levels =c('2','1','3')), 
         OrangeMites =factor(OrangeMites), 
         Year =factor(Year), 
         TagLeft =case_when(TagLeft == NA ~ TagRight, 
                            TRUE ~ TagLeft), 
         Date.Julian =as.numeric(format(as.POSIXct(Date, formate="%Y-%m-%d"), "%j"))) |> 
  select(c(Date:Year, Date.Julian)) |> 
  clean_names(case="all_caps") 

abund_1 <- rbind(abund,abund_2020) |> 
  clean_names() |>
  mutate(orange_mites_y_n = toupper(orange_mites_y_n), 
         species = toupper(species), 
         orange_mites_y_n = replace_na(orange_mites_y_n, "N"), 
         year = year(date), 
         month = month(date),  
         tag_left = coalesce(tag_left,tag_right), 
         tag_left = ifelse(tag_left=="RIP", tag_right, tag_left)) |> 
  group_by(year) |> 
  mutate(first_om_appearence = min(date[orange_mites_y_n=="Y"])) |>
  ungroup() |> 
  subset(date > first_om_appearence) |> 
  mutate(month_name = month.abb[month],
         species = case_when((species == "SM") ~ "DM",
                             (species == "NFLYER") ~ "FLYER",
                             TRUE ~ species),
         trapline_group = as.numeric(trapline), #make a separate group that groups traplines based on habitat type
         trapline_group = case_when((trapline >100 & trapline<200) ~ 100,
                                    (trapline >200 & trapline<300) ~ 200,
                                    (trapline >300 & trapline<400) ~ 300,
                                    (trapline >400 & trapline<500) ~ 400,
                                    (trapline >500 & trapline<600) ~ 500,
                                    (trapline >700 & trapline<800) ~ 700,
                                    (trapline >800 & trapline<900) ~ 800,
                                    TRUE ~ 900)) |> #place new column next to the 'trapline' column to make sure it worked
  relocate(trapline_group, .after=trapline) |> 
  unite("group_ID", year, month_name, trapline_group, remove = F)

abund_2 <-  abund_1 |> 
  select(c("group_ID":"species", "tag_left", "year":"month_name")) |>
  group_by(year) |> 
  distinct(tag_left, .keep_all = T) |>
  ungroup() |>
  reshape2::dcast(group_ID~species, length) |> 
  select(-c(`TRAP MALFUNCTION`, SOREX)) |> #`TRAP DISTURBANCE`
  mutate(total =rowSums(across(-group_ID)), 
         perc_rbv = RBV/total) 

#join 'abund_2' dataframe to 'orangemitedata_v3' dataframe by the group_ID column 
#so that the percentage of voles within a community (per month) can be recorded for each observation
orangemitedata_v3 <- orangemitedata_v2 |> 
  mutate(year = year(DATE), 
         month = month(DATE),
         month_name = month.abb[month], 
         trapline_group= as.numeric(as.character(TRAPLINE))*100) |> 
  unite("group_ID", year,month_name,trapline_group, remove=F) |>
  left_join(abund_2[,c(1,11)], by="group_ID") |> 
  clean_names(case="all_caps") 

orangemitedata_y1y2 <- orangemitedata_v3|> 
  select(c(TRAPLINE, SPECIES, TAG_LEFT,ORANGE_MITES,YEAR,DATE_JULIAN)) |> 
  filter(TRAPLINE != 9) |>
  filter(YEAR ==1 | YEAR ==2) |>
  mutate(TRAPLINE =factor(TRAPLINE, levels=c('4','1','2','3','5','7','8')), 
         YEAR =factor(YEAR, levels =c('1','2'))) 

orangemitedata_y3y4 <- orangemitedata_v3|> 
  select(c(TRAPLINE, SPECIES, TAG_LEFT,ORANGE_MITES,YEAR,DATE_JULIAN)) |> 
  filter(TRAPLINE != 9) |> 
  filter(YEAR ==3 | YEAR ==4) |>
  mutate(TRAPLINE =factor(TRAPLINE, levels=c('4','1','2','3','5','7','8')), 
         YEAR =factor(YEAR, levels =c('3','4')))  
```

# Descriptive statistics 

```{r}
temp1 <- separate(abund_2, group_ID, c("year","month","trapline.no"))|> 
  filter(year=="2016"|year=="2017")
summarise_all(temp1[4:12],funs(sum))/sum(temp1[12]) 

temp1 |> select("trapline.no","DM","RBV","WJM") |> 
  mutate(trapline.no =factor(trapline.no)) |>
  group_by(trapline.no) |> 
  summarise_each(list(sum))

temp2 <- separate(abund_2, group_ID, c("year","month","trapline.no"))|> 
  filter(year=="2018"|year=="2020")
summarise_all(temp2[4:12],funs(sum))/sum(temp2[12])

temp2 |> select("trapline.no","DM","RBV","WJM") |> 
  mutate(trapline.no =factor(trapline.no)) |>
  group_by(trapline.no) |> 
  summarise_each(list(sum))
```

# Data analysis {.tabset}

## High-RBV year 

### Fit models  

#### priors

```{r eval=FALSE, echo=TRUE, message =FALSE}
get_priors_y1y2 <- get_prior(ORANGE_MITES~SPECIES+TRAPLINE+YEAR+scale(DATE_JULIAN, center =TRUE, scale =TRUE)+SPECIES:TRAPLINE+SPECIES:scale(DATE_JULIAN, center =TRUE, scale =TRUE)+(1|TAG_LEFT), 
                         data=orangemitedata_y1y2,
                         family=bernoulli()) ;get_priors_y1y2 
```

```{r}
priors_y1y2 <- c(set_prior("normal(0,5)", class ="Intercept"), 
                 set_prior("normal(0,5)", class="b")) 
```

#### model formula 

```{r}
comm.comp1.formula <- bf(ORANGE_MITES~SPECIES+TRAPLINE+YEAR+scale(DATE_JULIAN, center=TRUE, scale =TRUE)+SPECIES:TRAPLINE+SPECIES:scale(DATE_JULIAN, center =TRUE, scale =TRUE)+(1|TAG_LEFT), 
                         family=bernoulli())
```

#### Fit model 

```{r eval=FALSE, echo=TRUE}
comm.comp1.2025 <- brm(comm.comp1.formula, 
                       data =orangemitedata_y1y2, 
                       family=bernoulli(), 
                       prior = priors_y1y2,
                       iter =2000,
                       warmup = 1000, 
                       seed=123,
                       thin=2,
                       chains = 4,
                       cores = 2, 
                       save_pars = save_pars(all = TRUE), 
                       sample_prior = "yes")
saveRDS(comm.comp1.2025, "models/comm_comp1_2025.RDS")
```

```{r load model, eval=TRUE, echo=FALSE}
comm.comp1.2025 <- readRDS("C:/Users/jc527762/OneDrive - James Cook University/OrangeMitesSmallMammal/N.-harperi-and-small-mammal-communities/models/comm_comp1_2025.RDS")
```


#### model validations (convergence)

```{r}
stan_trace(comm.comp1.2025$fit)
stan_ac(comm.comp1.2025$fit) 
stan_rhat(comm.comp1.2025$fit) 
stan_ess(comm.comp1.2025$fit)
stan_dens(comm.comp1.2025$fit, separate_chains = TRUE) 
```

#### model validation (DHARMa)

```{r}
# not sure how...
```

### model investigation {.tabset}

#### summary

```{r}
summary(comm.comp1.2025)
```

#### joint tests

```{r}
comm.comp1.2025 |> emmeans(~ SPECIES | TRAPLINE, type ="response") |> regrid() |> joint_tests()
```

#### R-squared

```{r}
comm.comp1.2025 |> bayes_R2(summary =FALSE) |> median_hdci()
```

#### {-}

### post-hoc analysis

```{r}
comm.comp1.2025 |> emmeans(~ SPECIES | TRAPLINE, type ="response") |> regrid() |> pairs(by="TRAPLINE") |> summary()
comm.comp1.2025 |> emmeans(~ SPECIES | TRAPLINE, type ="response") |> regrid() |> pairs(by="SPECIES") |> summary()
```

### probabilities

```{r}
comm.comp1.2025 |> emmeans(~SPECIES*TRAPLINE, type ="response")

```

### prob. comparisons 

```{r}
mtsqst1 <- comm.comp1.2025 |> emmeans(pairwise~SPECIES*TRAPLINE)
mtsqrt2 <- mtsqst1$contrasts |> gather_emmeans_draws() |> 
  filter(contrast %in% c(
    "SPECIES2 TRAPLINE4 - SPECIES1 TRAPLINE4", 
    "SPECIES2 TRAPLINE4 - SPECIES3 TRAPLINE4", 
    "SPECIES2 TRAPLINE2 - SPECIES1 TRAPLINE2", 
    "SPECIES2 TRAPLINE2 - SPECIES3 TRAPLINE2", 
    "SPECIES2 TRAPLINE3 - SPECIES1 TRAPLINE3", 
    "SPECIES2 TRAPLINE3 - SPECIES3 TRAPLINE3",
    "SPECIES2 TRAPLINE5 - SPECIES1 TRAPLINE5", 
    "SPECIES2 TRAPLINE5 - SPECIES3 TRAPLINE5",
    "SPECIES2 TRAPLINE7 - SPECIES1 TRAPLINE7", 
    "SPECIES2 TRAPLINE7 - SPECIES3 TRAPLINE7",
    "SPECIES2 TRAPLINE8 - SPECIES1 TRAPLINE8", 
    "SPECIES2 TRAPLINE8 - SPECIES3 TRAPLINE8",
    "SPECIES2 TRAPLINE1 - SPECIES1 TRAPLINE1", 
    "SPECIES2 TRAPLINE1 - SPECIES3 TRAPLINE1"
    ))
mtsqrt2 %>% group_by(contrast) %>% dplyr::summarise(Prob = sum(.value>0)/n()) 
```


### partial effects plots 

```{r}
comm.comp1.2025 |> conditional_effects(spaghetti = TRUE, ndraws =200)
```

### summary figures 

```{r}
var <- get_variables(comm.comp1.2025)
vari <- get_variables(comm.comp1.2025)[c(1,4:9,12:23)]

comm.comp1_int_draws2 <- comm.comp1.2025 |> spread_draws(!!!syms(vari)) 

comm.comp1_draws <- comm.comp1.2025 |> gather_draws(b_Intercept, b_SPECIES1, b_SPECIES3) |> 
  left_join(comm.comp1_int_draws2, by = c(".chain",".iteration",".draw")) |> 
  mutate(TRAPLINE4_mean = case_when(`.variable` == 'b_Intercept' ~ 
                                      `.value`,
                                    `.variable` != 'b_Intercept' ~ 
                                      `.value` + b_Intercept), 
         TRAPLINE1_mean = case_when(`.variable` == 'b_Intercept' ~ 
                                      `.value` + b_TRAPLINE1, 
                                    `.variable` == 'b_SPECIES1' ~ 
                                      `.value` + b_Intercept + 
                                      b_TRAPLINE1 + `b_SPECIES1:TRAPLINE1`, 
                                    `.variable` == 'b_SPECIES3' ~ 
                                      `.value` + b_Intercept + 
                                      b_TRAPLINE1 + `b_SPECIES3:TRAPLINE1`), 
         
         TRAPLINE2_mean = case_when(`.variable` == 'b_Intercept' ~ 
                                      `.value` + b_TRAPLINE2, 
                                    `.variable` == 'b_SPECIES1' ~ 
                                      `.value` + b_Intercept + 
                                      b_TRAPLINE2 + `b_SPECIES1:TRAPLINE2`, 
                                    `.variable` == 'b_SPECIES3' ~ 
                                      `.value` + b_Intercept + 
                                      b_TRAPLINE2 + `b_SPECIES3:TRAPLINE2`), 
         
         TRAPLINE3_mean = case_when(`.variable` == 'b_Intercept' ~ 
                                      `.value` + b_TRAPLINE3, 
                                    `.variable` == 'b_SPECIES1' ~ 
                                      `.value` + b_Intercept + 
                                      b_TRAPLINE3 + `b_SPECIES1:TRAPLINE3`, 
                                    `.variable` == 'b_SPECIES3' ~ 
                                      `.value` + b_Intercept + 
                                      b_TRAPLINE3 + `b_SPECIES3:TRAPLINE3`), 
         
         TRAPLINE5_mean = case_when(`.variable` == 'b_Intercept' ~ 
                                      `.value` + b_TRAPLINE5, 
                                    `.variable` == 'b_SPECIES1' ~ 
                                      `.value` + b_Intercept + 
                                      b_TRAPLINE5 + `b_SPECIES1:TRAPLINE5`, 
                                    `.variable` == 'b_SPECIES3' ~ 
                                      `.value` + b_Intercept + 
                                      b_TRAPLINE5 + `b_SPECIES3:TRAPLINE5`), 
         
         TRAPLINE7_mean = case_when(`.variable` == 'b_Intercept' ~ 
                                      `.value` + b_TRAPLINE7, 
                                    `.variable` == 'b_SPECIES1' ~ 
                                      `.value` + b_Intercept + 
                                      b_TRAPLINE7 + `b_SPECIES1:TRAPLINE7`, 
                                    `.variable` == 'b_SPECIES3' ~ 
                                      `.value` + b_Intercept + 
                                      b_TRAPLINE7 + `b_SPECIES3:TRAPLINE7`), 
         
         TRAPLINE8_mean = case_when(`.variable` == 'b_Intercept' ~ 
                                      `.value` + b_TRAPLINE8, 
                                    `.variable` == 'b_SPECIES1' ~ 
                                      `.value` + b_Intercept + 
                                      b_TRAPLINE8 + `b_SPECIES1:TRAPLINE8`, 
                                    `.variable` == 'b_SPECIES3' ~ 
                                      `.value` + b_Intercept + 
                                      b_TRAPLINE8 + `b_SPECIES3:TRAPLINE8`), 
         
         transformed_trapline4 = exp(TRAPLINE4_mean)/(1+exp(TRAPLINE4_mean)), 
         transformed_trapline1 = exp(TRAPLINE1_mean)/(1+exp(TRAPLINE1_mean)), 
         transformed_trapline2 = exp(TRAPLINE2_mean)/(1+exp(TRAPLINE2_mean)), 
         transformed_trapline3 = exp(TRAPLINE3_mean)/(1+exp(TRAPLINE3_mean)), 
         transformed_trapline5 = exp(TRAPLINE5_mean)/(1+exp(TRAPLINE5_mean)), 
         transformed_trapline7 = exp(TRAPLINE7_mean)/(1+exp(TRAPLINE7_mean)), 
         transformed_trapline8 = exp(TRAPLINE8_mean)/(1+exp(TRAPLINE8_mean))) 

comm.comp1_draws_plotting <-  comm.comp1_draws |> 
  pivot_longer(cols = starts_with("transformed"), 
               names_to = "TRAPLINE", 
               values_to = "infect_prob") %>% 
  transmute(species = case_when(`.variable` == "b_Intercept" ~ "RBV", 
                                `.variable` == "b_SPECIES1" ~ "DM", 
                                `.variable` == "b_SPECIES3" ~ "WJM"), 
            trapline = case_when(TRAPLINE == 'transformed_trapline4' ~ "trapline4", 
                                 TRAPLINE == 'transformed_trapline1' ~ "trapline1", 
                                 TRAPLINE == 'transformed_trapline2' ~ "trapline2",
                                 TRAPLINE == 'transformed_trapline3' ~ "trapline3",
                                 TRAPLINE == 'transformed_trapline5' ~ "trapline5",
                                 TRAPLINE == 'transformed_trapline7' ~ "trapline7",
                                 TRAPLINE == 'transformed_trapline8' ~ "trapline8"), 
            infect_prob = infect_prob, 
            speciesb = species, 
            traplineb = trapline, 
            chain = `.chain`, 
            iteration = `.iteration`, 
            draw_num = `.draw`) %>% 
  unite("id",speciesb,traplineb,sep = "_") %>% 
  mutate(id = factor(id, levels = c("RBV_trapline4","DM_trapline4","WJM_trapline4", 
                                    "RBV_trapline1","DM_trapline1","WJM_trapline1", 
                                    "RBV_trapline2","DM_trapline2","WJM_trapline2", 
                                    "RBV_trapline3","DM_trapline3","WJM_trapline3",
                                    "RBV_trapline5","DM_trapline5","WJM_trapline5",
                                    "RBV_trapline7","DM_trapline7","WJM_trapline7",
                                    "RBV_trapline8","DM_trapline8","WJM_trapline8"))) 

trapline_names <- c("Sugar maple hardwood", " Cut-over mixed-wood", "Dense mixed-wood",
                    "Conifer", "White pine/white spruce", "Black spruce/aspen", 
                    "White/red pine")
trapline_index <- c("trapline1","trapline2","trapline3","trapline4","trapline5",
                    "trapline7","trapline8") 
species_labels <- c("DM" = "Deer mouse","RBV" = "Red-Backed Vole","WJM" = "Woodland Jumping Mouse") 
```

```{r eval=FALSE, echo=FALSE}
#img1 <- pick_phylopic(name = "Peromyscus leucopus")
```


```{r ridge_plot1, fig.height=10, fig.width=14}

ridge_plot1 <- comm.comp1_draws_plotting |> 
  ggplot(aes(infect_prob, trapline, fill = species)) +
  scale_fill_manual(values = alpha(c("#7C8081","#7E4640",  "#ABA159"),0.7)) +
  geom_density_ridges_gradient(scale=2, rel_min_height = 0.01) +
  facet_wrap(~species, labeller = labeller(species = species_labels))+
  theme_bw()+ 
  scale_x_continuous(breaks = seq(0, 1, by = .2))+
  xlab("Probability of infection")+ylab("Habitat type")+ 
  scale_y_discrete(limits =c("trapline1",
                             "trapline8",
                             "trapline5",
                             "trapline2", 
                             "trapline7",
                             "trapline3",
                             "trapline4"),
    labels = c("Sugar maple hardwood", 
               "White/red pine",
               "White pine/white spruce",
               "Cut-over mixed-wood",  
               "Black spruce/aspen",  
               "Dense mixed-wood",
               "Conifer"))+
  theme(axis.text=element_text(size=18),
        axis.title=element_text(size=25,face="bold"), 
        strip.text = element_text(size=18), 
        legend.position = "none", 
        panel.grid.major = element_blank(), panel.grid.minor = element_blank());ridge_plot1
            
```

```{r echo =TRUE, eval =FALSE}
ggsave("outputs/2025_Community_composition_1.pdf", width =13, height =8, units ="in", dpi =300) 
ridge_plot1 
dev.off()
```

```{r fig.height=20, fig.width=15, eval=FALSE, echo=TRUE}
comm.comp1_int_draws2 |>
  pivot_longer(everything(), names_to = 'var', values_to = 'value') |>
  dplyr::filter(!var %in% c('.chain', '.draw', '.iteration')) |>
  ggplot(aes(x = value)) +
  geom_density() +
  facet_wrap(~ var, ncol = 1, scales = 'free_y') + 
  geom_vline(xintercept=0, color="red")
```

### summary figure 2

```{r}
date.plot <- orangemitedata_y1y2 |> 
  group_by(SPECIES, TRAPLINE) |> 
  modelr::data_grid(DATE_JULIAN=seq(from=120, 
                          to=max(orangemitedata_y1y2$DATE_JULIAN), 
                          length.out=100),
            YEAR=1) |> 
  add_fitted_draws(comm.comp1.2025,
                   n =100,
                   re_formula=NA) |>  
  #unite("exp_group", c("region","dev.temp"), remove=FALSE) |> 
  ggplot(aes(x=DATE_JULIAN, color=SPECIES)) + 
  geom_line(aes(y=.value, group=paste(SPECIES, .draw)), alpha=0.05) + 
  geom_smooth(aes(y=.value, color=SPECIES), se=FALSE, size=1.5) + 
  theme_classic() + 
  facet_wrap(~TRAPLINE); date.plot
```


## Low-RBV year 

### Fit models 

#### priors

```{r eval=FALSE, echo=TRUE, message =FALSE}
get_priors_y3y4 <- get_prior(ORANGE_MITES~SPECIES+TRAPLINE+YEAR+scale(DATE_JULIAN, center =TRUE, scale =TRUE)+SPECIES:TRAPLINE+SPECIES:scale(DATE_JULIAN, center =TRUE, scale =TRUE)+(1|TAG_LEFT), 
                         data=orangemitedata_y3y4,
                         family=bernoulli()) ;get_priors_y3y4 
```

```{r}
priors_y3y4 <- c(set_prior("normal(0,5)", class ="Intercept"), 
                 set_prior("normal(0,5)", class="b")) 
```

#### model formula 

```{r}
comm.comp2.formula <- bf(ORANGE_MITES~SPECIES+TRAPLINE+YEAR+scale(DATE_JULIAN, center=TRUE, scale =TRUE)+SPECIES:TRAPLINE+SPECIES:scale(DATE_JULIAN, center =TRUE, scale =TRUE)+(1|TAG_LEFT), 
                         family=bernoulli())
```

#### Fit model 

```{r eval=FALSE, echo=TRUE}
comm.comp2.2025 <- brm(comm.comp2.formula, 
                       data =orangemitedata_y3y4, 
                       family=bernoulli(), 
                       prior = priors_y3y4,
                       iter =8000,
                       warmup = 4000, 
                       seed=123,
                       thin=2,
                       chains = 4,
                       cores = 2, 
                       save_pars = save_pars(all = TRUE), 
                       sample_prior = "yes", 
                       control = list(adapt_delta=0.99, max_treedepth=15))
saveRDS(comm.comp2.2025, "models/comm_comp2_2025.RDS")
```

```{r load-model2, eval=TRUE, echo=FALSE}
comm.comp2.2025 <- readRDS("C:/Users/jc527762/OneDrive - James Cook University/OrangeMitesSmallMammal/N.-harperi-and-small-mammal-communities/models/comm_comp2_2025.RDS")
```

#### model validations (convergence)

```{r}
stan_trace(comm.comp2.2025$fit)
stan_ac(comm.comp2.2025$fit) 
stan_rhat(comm.comp2.2025$fit) 
stan_ess(comm.comp2.2025$fit)
stan_dens(comm.comp2.2025$fit, separate_chains = TRUE) 
```

### model investigation {.tabset}

#### summary

```{r}
summary(comm.comp2.2025)
```

#### joint tests

```{r}
comm.comp2.2025 |> emmeans(~ SPECIES | TRAPLINE, type ="response") |> regrid() |> joint_tests()
```

#### R-squared

```{r}
comm.comp2.2025 |> bayes_R2(summary =FALSE) |> median_hdci()
```

#### {-}

### post-hoc analysis

```{r}
comm.comp2.2025 |> emmeans(~ SPECIES | TRAPLINE, type ="response") |> regrid() |> pairs(by="TRAPLINE") |> summary()
comm.comp2.2025 |> emmeans(~ SPECIES | TRAPLINE, type ="response") |> regrid() |> pairs(by="SPECIES") |> summary()
```

### probabilities

```{r}
comm.comp2.2025 |> emmeans(~SPECIES*TRAPLINE, type ="response")

mtsqst1 <- comm.comp2.2025 |> emmeans(pairwise~SPECIES*TRAPLINE)
mtsqrt2 <- mtsqst1$contrasts |> gather_emmeans_draws() |> 
  filter(contrast %in% c(
    "SPECIES2 TRAPLINE4 - SPECIES1 TRAPLINE4", 
    #"SPECIES2 TRAPLINE4 - SPECIES3 TRAPLINE4", 
    "SPECIES2 TRAPLINE2 - SPECIES1 TRAPLINE2", 
    #"SPECIES2 TRAPLINE2 - SPECIES3 TRAPLINE2", 
    "SPECIES2 TRAPLINE3 - SPECIES1 TRAPLINE3", 
    #"SPECIES2 TRAPLINE3 - SPECIES3 TRAPLINE3",
    #"SPECIES2 TRAPLINE5 - SPECIES1 TRAPLINE5", 
    #"SPECIES2 TRAPLINE5 - SPECIES3 TRAPLINE5",
    "SPECIES2 TRAPLINE7 - SPECIES1 TRAPLINE7", 
    #"SPECIES2 TRAPLINE7 - SPECIES3 TRAPLINE7",
    "SPECIES2 TRAPLINE8 - SPECIES1 TRAPLINE8" 
    #"SPECIES2 TRAPLINE8 - SPECIES3 TRAPLINE8",
    #"SPECIES2 TRAPLINE1 - SPECIES1 TRAPLINE1", 
    #"SPECIES2 TRAPLINE1 - SPECIES3 TRAPLINE1"
    ))
mtsqrt2 %>% group_by(contrast) %>% dplyr::summarise(Prob = sum(.value>0)/n())  


```


### partial effects plots 

```{r}
comm.comp2.2025 |> conditional_effects(spaghetti = TRUE, ndraws =200)
```

### summary figure 

```{r}
var <- get_variables(comm.comp2.2025)
vari <- get_variables(comm.comp2.2025)[c(1,4:9,12:23)]

comm.comp2_int_draws2 <- comm.comp2.2025 |> spread_draws(!!!syms(vari)) 

comm.comp2_draws <- comm.comp2.2025 |> gather_draws(b_Intercept, b_SPECIES1, b_SPECIES3) |> 
  left_join(comm.comp2_int_draws2, by = c(".chain",".iteration",".draw")) |> 
  mutate(TRAPLINE4_mean = case_when(`.variable` == 'b_Intercept' ~ 
                                      `.value`,
                                    `.variable` != 'b_Intercept' ~ 
                                      `.value` + b_Intercept), 
         TRAPLINE1_mean = case_when(`.variable` == 'b_Intercept' ~ 
                                      `.value` + b_TRAPLINE1, 
                                    `.variable` == 'b_SPECIES1' ~ 
                                      `.value` + b_Intercept + 
                                      b_TRAPLINE1 + `b_SPECIES1:TRAPLINE1`, 
                                    `.variable` == 'b_SPECIES3' ~ 
                                      `.value` + b_Intercept + 
                                      b_TRAPLINE1 + `b_SPECIES3:TRAPLINE1`), 
         
         TRAPLINE2_mean = case_when(`.variable` == 'b_Intercept' ~ 
                                      `.value` + b_TRAPLINE2, 
                                    `.variable` == 'b_SPECIES1' ~ 
                                      `.value` + b_Intercept + 
                                      b_TRAPLINE2 + `b_SPECIES1:TRAPLINE2`, 
                                    `.variable` == 'b_SPECIES3' ~ 
                                      `.value` + b_Intercept + 
                                      b_TRAPLINE2 + `b_SPECIES3:TRAPLINE2`), 
         
         TRAPLINE3_mean = case_when(`.variable` == 'b_Intercept' ~ 
                                      `.value` + b_TRAPLINE3, 
                                    `.variable` == 'b_SPECIES1' ~ 
                                      `.value` + b_Intercept + 
                                      b_TRAPLINE3 + `b_SPECIES1:TRAPLINE3`, 
                                    `.variable` == 'b_SPECIES3' ~ 
                                      `.value` + b_Intercept + 
                                      b_TRAPLINE3 + `b_SPECIES3:TRAPLINE3`), 
         
         TRAPLINE5_mean = case_when(`.variable` == 'b_Intercept' ~ 
                                      `.value` + b_TRAPLINE5, 
                                    `.variable` == 'b_SPECIES1' ~ 
                                      `.value` + b_Intercept + 
                                      b_TRAPLINE5 + `b_SPECIES1:TRAPLINE5`, 
                                    `.variable` == 'b_SPECIES3' ~ 
                                      `.value` + b_Intercept + 
                                      b_TRAPLINE5 + `b_SPECIES3:TRAPLINE5`), 
         
         TRAPLINE7_mean = case_when(`.variable` == 'b_Intercept' ~ 
                                      `.value` + b_TRAPLINE7, 
                                    `.variable` == 'b_SPECIES1' ~ 
                                      `.value` + b_Intercept + 
                                      b_TRAPLINE7 + `b_SPECIES1:TRAPLINE7`, 
                                    `.variable` == 'b_SPECIES3' ~ 
                                      `.value` + b_Intercept + 
                                      b_TRAPLINE7 + `b_SPECIES3:TRAPLINE7`), 
         
         TRAPLINE8_mean = case_when(`.variable` == 'b_Intercept' ~ 
                                      `.value` + b_TRAPLINE8, 
                                    `.variable` == 'b_SPECIES1' ~ 
                                      `.value` + b_Intercept + 
                                      b_TRAPLINE8 + `b_SPECIES1:TRAPLINE8`, 
                                    `.variable` == 'b_SPECIES3' ~ 
                                      `.value` + b_Intercept + 
                                      b_TRAPLINE8 + `b_SPECIES3:TRAPLINE8`), 
         
         transformed_trapline4 = exp(TRAPLINE4_mean)/(1+exp(TRAPLINE4_mean)), 
         transformed_trapline1 = exp(TRAPLINE1_mean)/(1+exp(TRAPLINE1_mean)), 
         transformed_trapline2 = exp(TRAPLINE2_mean)/(1+exp(TRAPLINE2_mean)), 
         transformed_trapline3 = exp(TRAPLINE3_mean)/(1+exp(TRAPLINE3_mean)), 
         transformed_trapline5 = exp(TRAPLINE5_mean)/(1+exp(TRAPLINE5_mean)), 
         transformed_trapline7 = exp(TRAPLINE7_mean)/(1+exp(TRAPLINE7_mean)), 
         transformed_trapline8 = exp(TRAPLINE8_mean)/(1+exp(TRAPLINE8_mean))) 

comm.comp2_draws_plotting <-  comm.comp2_draws %>% 
  pivot_longer(cols = starts_with("transformed"), 
               names_to = "TRAPLINE", 
               values_to = "infect_prob") %>% 
  transmute(species = case_when(`.variable` == "b_Intercept" ~ "RBV", 
                                `.variable` == "b_SPECIES1" ~ "DM", 
                                `.variable` == "b_SPECIES3" ~ "WJM"), 
            trapline = case_when(TRAPLINE == 'transformed_trapline4' ~ "trapline4", 
                                 TRAPLINE == 'transformed_trapline1' ~ "trapline1", 
                                 TRAPLINE == 'transformed_trapline2' ~ "trapline2",
                                 TRAPLINE == 'transformed_trapline3' ~ "trapline3",
                                 TRAPLINE == 'transformed_trapline5' ~ "trapline5",
                                 TRAPLINE == 'transformed_trapline7' ~ "trapline7",
                                 TRAPLINE == 'transformed_trapline8' ~ "trapline8"), 
            infect_prob = infect_prob, 
            speciesb = species, 
            traplineb = trapline, 
            chain = `.chain`, 
            iteration = `.iteration`, 
            draw_num = `.draw`) %>% 
  unite("id",speciesb,traplineb,sep = "_") %>% 
  mutate(id = factor(id, levels = c("RBV_trapline4","DM_trapline4","WJM_trapline4", 
                                    "RBV_trapline1","DM_trapline1","WJM_trapline1", 
                                    "RBV_trapline2","DM_trapline2","WJM_trapline2", 
                                    "RBV_trapline3","DM_trapline3","WJM_trapline3",
                                    "RBV_trapline5","DM_trapline5","WJM_trapline5",
                                    "RBV_trapline7","DM_trapline7","WJM_trapline7",
                                    "RBV_trapline8","DM_trapline8","WJM_trapline8"))) 

trapline_names <- c("Sugar maple hardwood", " Cut-over mixed-wood", "Dense mixed-wood",
                    "Conifer", "White pine/white spruce", "Black spruce/aspen", 
                    "White/red pine")
trapline_index <- c("trapline1","trapline2","trapline3","trapline4","trapline5",
                    "trapline7","trapline8") 
species_labels <- c("DM" = "Deer mouse","RBV" = "Red-Backed Vole","WJM" = "Woodland Jumping Mouse") 
```

```{r eval=FALSE, echo=FALSE}
#img1 <- pick_phylopic(name = "Peromyscus leucopus")
```


```{r ridge-plot2, fig.height=10, fig.width=14}

ridge_plot2 <- comm.comp2_draws_plotting %>% 
  ggplot(aes(infect_prob, trapline, fill = species)) +
  scale_fill_manual(values = alpha(c("#7C8081","#7E4640",  "#ABA159"),0.7)) +
  geom_density_ridges_gradient(scale = 2, rel_min_height = 0.01)+
  facet_wrap(~species, labeller = labeller(species = species_labels))+
  theme_bw()+ 
  scale_x_continuous(breaks = seq(0, 1, by = .2))+
  xlab("P(Infection)")+ylab("Habitat type")+ 
  scale_y_discrete(limits =c("trapline1",
                             "trapline8",
                             "trapline5",
                             "trapline2", 
                             "trapline7",
                             "trapline3",
                             "trapline4"),
    labels = c("Sugar maple hardwood", 
               "White/red pine",
               "White pine/white spruce",
               "Cut-over mixed-wood",  
               "Black spruce/aspen",  
               "Dense mixed-wood",
               "Conifer"))+
  theme(axis.text=element_text(size=18),
        axis.title=element_text(size=25,face="bold"), 
        strip.text = element_text(size=18), 
        legend.position = "none", 
        panel.grid.major = element_blank(), panel.grid.minor = element_blank());ridge_plot2
              #img = img1, x=0.2, y=7.8, height =2, fill ="#7C8081", 
              # color = "black", 
               #alpha = 0.6)
```

```{r echo =TRUE, eval =FALSE}
ggsave("outputs/2025_Community_composition_2.pdf", width =13, height =8, units ="in", dpi =300) 
ridge_plot2 
dev.off()
```

### summary figure 2

```{r}
date.plot <- orangemitedata_y3y4 |> 
  group_by(SPECIES, TRAPLINE) |> 
  modelr::data_grid(DATE_JULIAN=seq(from=120, 
                          to=max(orangemitedata_y3y4$DATE_JULIAN), 
                          length.out=100),
            YEAR=3) |> 
  add_fitted_draws(comm.comp2.2025,
                   n =100,
                   re_formula=NA) |>  
  #unite("exp_group", c("region","dev.temp"), remove=FALSE) |> 
  ggplot(aes(x=DATE_JULIAN, color=SPECIES)) + 
  geom_line(aes(y=.value, group=paste(SPECIES, .draw)), alpha=0.05) + 
  geom_smooth(aes(y=.value, color=SPECIES), se=FALSE, size=1.5) + 
  theme_classic() + 
  facet_wrap(~TRAPLINE); date.plot
```


## RBV community presence 

### Fit models 

#### Data manipulation

```{r}
orangemitedata_perc.RBV <- orangemitedata_v3|> 
  select(c(TRAPLINE, SPECIES, TAG_LEFT,ORANGE_MITES,YEAR,DATE_JULIAN,PERC_RBV)) |> 
  filter(TRAPLINE != 9) |>
  mutate(TRAPLINE =factor(TRAPLINE, levels=c('4','1','2','3','5','6','7','8'))) 
```

#### priors

```{r eval=FALSE, echo=TRUE, message =FALSE}
get_rbv.perc <- get_prior(ORANGE_MITES~PERC_RBV*SPECIES+(1|TAG_LEFT), 
                family=bernoulli(), 
                data=orangemitedata_perc.RBV);get_rbv.perc 
```

```{r}
rbv.perc_priors <- c(set_prior("normal(0,5)", class ="Intercept"), 
                 set_prior("normal(0,5)", class="b")) 
```

#### model formula 

```{r}
rbv.perc_formula <- bf(ORANGE_MITES~PERC_RBV*SPECIES+(1|TAG_LEFT), 
                family=bernoulli())
```

#### Fit model 

```{r eval=FALSE, echo=TRUE}
rbv.perc.2025 <- brm(rbv.perc_formula, 
                       data =orangemitedata_perc.RBV, 
                       family=bernoulli(), 
                       prior =rbv.perc_priors,
                       iter =2000,
                       warmup =1000, 
                       seed=123,
                       thin=2,
                       chains = 4,
                       cores = 2, 
                       save_pars = save_pars(all = TRUE), 
                       sample_prior = "yes", 
                       control = list(adapt_delta=0.99, max_treedepth=15))
saveRDS(rbv.perc.2025, "models/rbv_perc_2025.RDS")
```

```{r load-model-3, eval=TRUE, echo=FALSE}
rbv.perc.2025 <- readRDS("C:/Users/jc527762/OneDrive - James Cook University/OrangeMitesSmallMammal/N.-harperi-and-small-mammal-communities/models/rbv_perc_2025.RDS")
```

#### model validations (convergence)

```{r}
stan_trace(rbv.perc.2025$fit)
stan_ac(rbv.perc.2025$fit) 
stan_rhat(rbv.perc.2025$fit) 
stan_ess(rbv.perc.2025$fit)
stan_dens(rbv.perc.2025$fit, separate_chains = TRUE) 
```

### model investigation {.tabset}

#### summary

```{r}
summary(rbv.perc.2025)
```

#### hpd.summary

```{r}
rbv.perc.2025 |> emmeans(~SPECIES*PERC_RBV, type = "response") |> 
  hpd.summary(point.est =median)
```

#### R-squared

```{r}
rbv.perc.2025 |> bayes_R2(summary =FALSE) |> median_hdci()
```

#### {-}

### post-hoc analysis

```{r}
rbv.perc.2025 |> emtrends(var = "PERC_RBV", type = "response") |> regrid() |> summary(by = NULL, adjust = "tukey", infer=TRUE) 
rbv.perc.2025 |> emtrends(var = "PERC_RBV", type = "response") |> 
  pairs(by = "PERC_RBV") |>
  summary(by = NULL, adjust = "tukey", infer=TRUE) 
```

```{r}
rbv.perc.2025 |> emmeans(~SPECIES*PERC_RBV, type = "response")
rbv.perc.2025 |> emmeans(~SPECIES*PERC_RBV, type = "response") |> 
  pairs(by = "PERC_RBV") |>
  summary(by = NULL, 
          adjust = "tukey", 
          infer=TRUE)  

```

### partial effects plots 

```{r}
rbv.perc.2025 |> conditional_effects(spaghetti = TRUE, ndraws =200)
```

### Summary 

```{r}
perc_rbv.figure <- orangemitedata_v3 |>
  group_by(SPECIES) |> 
  modelr::data_grid(PERC_RBV=seq(from = min(orangemitedata_v3$PERC_RBV), 
                         to=max(orangemitedata_v3$PERC_RBV), 
                         length.out = 101)) |> 
  add_linpred_draws(rbv.perc.2025, ndraws=100,
                   re_formula = NA) |>
  mutate(.linpred =exp(.linpred)/(1+exp(.linpred))) |>
  ggplot(aes(x=PERC_RBV, color=SPECIES))+
  geom_line(aes(y=.linpred, group = paste(SPECIES, .draw)), alpha=0.2)+ 
  geom_smooth(aes(y=.linpred, color=SPECIES), se=F, size=1.5)+theme_classic()+ 
  xlab("% red backed vole in community composition")+ylab("Probability of infection")+ 
  scale_color_manual(labels=c("Red backed vole", "Deer mouse", "Woodland jumping mouse"), 
                     values=c("#7E4640","#7C8081","#ABA159"))   +
  theme(legend.position = "bottom", 
        legend.title = element_blank(), 
        axis.title.x = element_text(size=25), 
        axis.text.x = element_text(size=18), 
        axis.title.y = element_text(size=25), 
        axis.text.y = element_text(size=18), 
        legend.text = element_text(size=15), 
        axis.line = element_line(size=1.2)) 
  #geom_vline(xintercept = 0.2, color="black", alpha=0.4, size=1); prp 
perc_rbv.figure 
```

```{r eval=FALSE, echo =TRUE}
ggsave("outputs/2025_perc_rbv_pop_model.pdf", width =13, height =8, units ="in", dpi =300) 
perc_rbv.figure 
dev.off()
```

## Body condition 

### Load additional packages 

```{r warning =FALSE, message =FALSE}
library(vegan)
```

### Data manipulation
```{r data-manipulation-4.1, eval=TRUE, echo=TRUE}
sampling<- read_csv("data/sampling_periods.csv")
bc <- read_excel("data/Small Mammal Project 2016 (ALL)_cleaned.xlsx", 
                 sheet = "Falls Lines") |> 
  clean_names() |> #use the janitor package to clean up the names so everything's consistent
  filter(age == 'A') |> #subset to only adults JV
  filter(!(repro_cond == 'PERF/PREG' | repro_cond == 'Preg' | repro_cond == 'PREG' |
             repro_cond == 'Preg/Lac'| repro_cond == 'PREG/LAC' | 
             repro_cond == 'PREG/PERF')) |> #subset to remove preg JV
  mutate(skull_length = as.numeric(skull_length), tag_left = as.factor(tag_left)) |> #convert skull length to numeric like the rest of the variables JV 
  filter(species == 'DM' | species == 'RBV') |> #subset the df to only the species we're interested in
  mutate(julian_date = yday(date)) |> #group into sampling periods based on date
  #connect the sampling csv with this df by matching the julian dates
  #from each together
  left_join(sampling, by = "julian_date") |> 
  #so now we have a whole column of sampling periods based on the julian date
  #for each observation
  #now we order by individual
  arrange(tag_left) |> 
  #the group by individual and sampling period
  group_by(tag_left, sampling_period) |> 
  ##create average for weight JV
  mutate(avg_weight_sampling_period = mean(weight, na.rm = TRUE)) |>
  mutate(tag_left_num = as.numeric(tag_left)) |>
  distinct(avg_weight_sampling_period, tag_left_num, .keep_all = TRUE) |>
  #now remove that grouping variable so we can group by individual over the
  #whole summer now
  ungroup() |> 
  #by individual across all samples
  group_by(tag_left) |> 
  #make a new column to average measures we care about JV
  mutate(avg_tail_summer = mean(tail, na.rm = TRUE),
         avg_hindfoot_summer = mean(hindfoot, na.rm = TRUE),
         avg_ear_summer = mean(ear, na.rm = TRUE),
         avg_skull_width_summer = mean(skull_width, na.rm = TRUE),
         avg_skull_length_summer = mean(skull_length, na.rm = TRUE)) |>
  ##creating infection stages col JV
  mutate(group = case_when(any(orange_mites_y_n == "Y") ~ "Parasitized", TRUE ~ "Uninfected")) |>
  ungroup() |>
  mutate(infection_stage = case_when((group == "Parasitized" & orange_mites_y_n == "Y") ~ "After",
                                     (group == "Parasitized" & orange_mites_y_n == "N") ~ "Before",
                                     (group == "Uninfected") ~ "Before",
                                     TRUE ~ "NA")) |>
  ##There were two individuals that switched from having mites to not having mites
  ##The code below makes sure they are still listed as "after" when they lose their mites JV
  mutate(infection_stage = case_when((tag_left == 50468 & julian_date > 196) ~ "After",
                                     (tag_left == 50968 & julian_date > 207) ~ "After",
                                     TRUE ~ infection_stage)) |>
  mutate(group = as.factor(group), infection_stage = as.factor(infection_stage)) |>
  filter(infection_stage != "NA") |>
  unite(infection, c("group", "infection_stage"), remove = FALSE) |>
  mutate(infection = as.factor(infection)) |>
  ##removing NA's JV
  drop_na(avg_skull_width_summer, avg_skull_length_summer, avg_hindfoot_summer,
          avg_weight_sampling_period) |>
  ##formatting predictors JV
  mutate(sex = as.factor(sex)) 
```

### Split dataframes 

```{r}
rbv = bc |> 
  filter(species == "RBV") |> 
  mutate(sex = as.factor(sex)) 

dm = bc |> 
  filter(species == "DM") |> 
  mutate(sex = as.factor(sex)) 
```

### Red-backed voles

#### Princple component analysis (PCA)

```{r}
pca_rbv <- princomp(~ avg_hindfoot_summer + avg_skull_length_summer + avg_skull_width_summer, 
                    rbv, 
                    cor = TRUE)
loadings(pca_rbv)
summary(pca_rbv)
screeplot(pca_rbv)
eigenvals(pca_rbv) 
rbv$body_size_rbv <- (pca_rbv$scores[,1])
```

#### Data exploration 

```{r}
plot(avg_weight_sampling_period ~ body_size_rbv, 
     data =rbv)
```

only take first sample collected
```{r}
rbv2 <- rbv |> 
  group_by(tag_left) |> 
  summarise(across(everything(), first)) |>
  ungroup() 
table(rbv2$infection_stage)
```

#### priors

```{r eval=FALSE, echo=TRUE, message =FALSE}
get_RBVbodycondition_priors  <- get_prior(weight ~ infection_stage+scale(body_size_rbv)+sex*scale(julian_date), 
                      data=rbv2); get_RBVbodycondition_priors 
```

```{r}
RBVbodycondition_priors <- c(set_prior("normal(0,5)", class ="Intercept"),
                             set_prior("normal(0,5)", class="b")) 
```

#### model formula 

```{r}
RBVbodycondition_formula <- bf(weight ~ infection_stage + scale(body_size_rbv) + sex*scale(julian_date)) 
```

#### Fit model (work in progress)

```{r eval=FALSE, echo=TRUE}
RBVbodycondition <- brm(RBVbodycondition_formula, 
                       data =rbv2, 
                       family=gaussian(), 
                       prior =RBVbodycondition_priors,
                       iter =2000,
                       warmup =1000, 
                       seed=123,
                       thin=2,
                       chains = 3,
                       cores = 2, 
                       save_pars = save_pars(all = TRUE), 
                       sample_prior = "yes", 
                       control = list(adapt_delta=0.99, max_treedepth=15))
saveRDS(RBVbodycondition, "models/RBVbodycondition_2025.RDS")
```

```{r load-model-4.1, eval=TRUE, echo=FALSE}
RBVbodycondition <- readRDS("C:/Users/jc527762/OneDrive - James Cook University/OrangeMitesSmallMammal/N.-harperi-and-small-mammal-communities/models/RBVbodycondition_2025.RDS")
```

#### model validations (convergence)

```{r}
stan_trace(RBVbodycondition$fit)
stan_ac(RBVbodycondition$fit) 
stan_rhat(RBVbodycondition$fit) 
stan_ess(RBVbodycondition$fit)
stan_dens(RBVbodycondition$fit, separate_chains = TRUE) 
```

#### model investigation {.tabset}

##### summary

```{r}
summary(RBVbodycondition)
```

```{r}
posteriors <- as.data.frame(RBVbodycondition) 
covariate_samples <- posteriors |> select(b_Intercept, b_infectionParasitized_Before,b_infectionUninfected_Before) 
combined_effect <- rowSums(covariate_samples) 
hdi(combined_effect, credMass =0.95)
```

##### R-squared

```{r}
RBVbodycondition |> bayes_R2(summary =FALSE) |> median_hdci()
```

##### {-}

#### post-hoc analysis

##### Infection

```{r}
RBVbodycondition |> emmeans(~infection, type = "response") 
RBVbodycondition |> emmeans(~infection, type = "response") |> 
  pairs() |> summary(by = NULL, adjust = "tukey", infer=TRUE) 
```

##### sex

```{r}
RBVbodycondition |> emmeans(~sex, type = "response")
RBVbodycondition |> emmeans(~sex, type = "response") |> 
  pairs() |>
  summary(by = NULL, 
          adjust = "tukey", 
          infer=TRUE)  
```

##### julian date

```{r}
RBVbodycondition |> emtrends(var = "julian_date", type = "response") |> 
  summary(by = NULL, adjust = "tukey", infer=TRUE) 
```

#### partial effects plots 

```{r}
RBVbodycondition |> conditional_effects(spaghetti = TRUE, ndraws =200)
```

#### summary figure 

```{r}

```

### Deer mice 

#### Princple component analysis (PCA)

```{r warning=FALSE}
pca_dm <- princomp(~ avg_hindfoot_summer + avg_skull_length_summer + avg_skull_width_summer,
                   dm, 
                   cor = TRUE)
loadings(pca_dm)
summary(pca_dm)
screeplot(pca_dm)
eigenvals(pca_dm) 
dm$body_size_dm <- (pca_dm$scores[,1])
```

#### Data exploration 

```{r}
plot(avg_weight_sampling_period ~ body_size_dm, 
     data =dm)
```

only take first sample collected

```{r}
dm2 <- dm |> 
  group_by(tag_left) |> 
  summarise(across(everything(), first)) |>
  ungroup() 
table(dm2$infection_stage)
```

#### priors

```{r eval=FALSE, echo=TRUE, message =FALSE}
get_DMbodycondition_priors  <- get_prior(weight ~ infection_stage+scale(body_size_dm)+sex*scale(julian_date), 
                      data=dm2); get_DMbodycondition_priors 
```

```{r}
DMbodycondition_priors <- c(set_prior("normal(0,5)", class ="Intercept"),
                             set_prior("normal(0,5)", class="b")) 
```

#### model formula 

```{r}
DMbodycondition_formula <- bf(weight ~ infection_stage+scale(body_size_dm)+sex*scale(julian_date))
```

#### Fit model (work in progress)

```{r eval=FALSE, echo=TRUE}
DMbodycondition <- brm(DMbodycondition_formula, 
                       data =dm2, 
                       family=gaussian(), 
                       prior =DMbodycondition_priors,
                       iter =2000,
                       warmup =1000, 
                       seed=123,
                       thin=2,
                       chains = 4,
                       cores = 2, 
                       save_pars = save_pars(all = TRUE), 
                       sample_prior = "yes")
saveRDS(DMbodycondition, "models/DMbodycondition_2025.RDS")
```

```{r load-model-4.2, eval=TRUE, echo=FALSE}
DMbodycondition <- readRDS("C:/Users/jc527762/OneDrive - James Cook University/OrangeMitesSmallMammal/N.-harperi-and-small-mammal-communities/models/DMbodycondition_2025.RDS")
```

#### model validations (convergence)

```{r}
stan_trace(DMbodycondition$fit)
stan_ac(DMbodycondition$fit) 
stan_rhat(DMbodycondition$fit) 
stan_ess(DMbodycondition$fit)
stan_dens(DMbodycondition$fit, separate_chains = TRUE) 
```

#### model investigation {.tabset}

##### summary

```{r}
summary(DMbodycondition)
```

##### R-squared

```{r}
DMbodycondition |> bayes_R2(summary =FALSE) |> median_hdci()
```

##### {-}

#### post-hoc analysis

##### Infection

```{r}
posteriors <- as.data.frame(DMbodycondition) 
covariate_samples <- posteriors |> select(b_Intercept, b_infectionParasitized_Before,b_infectionUninfected_Before) 
combined_effect <- rowSums(covariate_samples) 
hdi(combined_effect, credMass =0.95)

DMbodycondition |> emmeans(~infection, type = "response") 
DMbodycondition |> emmeans(~infection, type = "response") |> 
  pairs() |> summary(by = NULL, adjust = "tukey", infer=TRUE) 
```

##### sex

```{r}
DMbodycondition |> emmeans(~sex, type = "response")
DMbodycondition |> emmeans(~sex, type = "response") |> 
  pairs() |>
  summary(by = NULL, 
          adjust = "tukey", 
          infer=TRUE)  
```

##### julian date

```{r}
DMbodycondition |> emtrends(var = "julian_date", type = "response") |> pairs(by='infection') |>
  summary(by = NULL, adjust = "tukey", infer=TRUE) 
```

#### partial effects plots 

```{r}
DMbodycondition |> conditional_effects(spaghetti = TRUE, ndraws =200)
```

#### summary figure 

##### Red backed voles
```{r}
rbv.infect <- as.data.frame(emmeans(RBVbodycondition, ~infection)) 

rbv.infect.obs <- drop_na(rbv, infection) |> 
  mutate(Pred =predict(RBVbodycondition, re.form =NULL, type ='response'), 
         Resid =residuals(RBVbodycondition, type ="ordinary"), 
         Fit =Pred+Resid) 
```

```{r}
rbv.bodycondition.plot <- ggplot(data =rbv.infect, aes(x=infection, y=emmean)) + 
  geom_jitter(data =rbv.infect.obs, aes(x= infection, y =Fit[,1]), 
              width=0.02,
              color ="#7E4640", 
              alpha =0.15) +
  geom_pointrange(aes(ymin =lower.HPD, 
                      ymax =upper.HPD), 
                      color ="black")+ 
  xlab("") + ylab("Body condition") + 
  scale_y_continuous(limits =c(-10,10)) +
  scale_x_discrete(limits =c("Uninfected_Before","Parasitized_Before","Parasitized_After")) +
  theme_classic() +
  theme(legend.position = "none", 
        axis.text.x = element_blank()); rbv.bodycondition.plot
```

##### Deer mice 
```{r}
dm.infect <- as.data.frame(emmeans(DMbodycondition, ~infection)) 

dm.infect.obs <- drop_na(dm, infection) |> 
  mutate(Pred =predict(DMbodycondition, re.form =NULL, type ='response'), 
         Resid =residuals(DMbodycondition, type ="ordinary"), 
         Fit =Pred+Resid) 
```

```{r}
dm.bodycondition.plot <- ggplot(data =rbv.infect, aes(x=infection, y=emmean)) + 
  geom_jitter(data =rbv.infect.obs, aes(x= infection, y =Fit[,1]), 
              width=0.02,
              color ="#7C8081", 
              alpha =0.25) +
  geom_pointrange(aes(ymin =lower.HPD, 
                      ymax =upper.HPD), 
                      color ="black") + 
  xlab("Infection status") + ylab("Body condition") + 
  scale_y_continuous(limits =c(-10,10)) +
  scale_x_discrete(limits =c("Uninfected_Before","Parasitized_Before","Parasitized_After")) +
  theme_classic() +
  theme(legend.position = "none"); dm.bodycondition.plot
```

##### merge plots 

```{r}
rbv.dm.bodycondition.plot <- (rbv.bodycondition.plot / dm.bodycondition.plot) + plot_annotation(tag_levels = 'A') ; rbv.dm.bodycondition.plot
```

##### save plot 

```{r eval=FALSE, echo =TRUE}
ggsave("outputs/2025_bodycondition2.pdf", width =5, height =5, units ="in", dpi =300) 
rbv.dm.bodycondition.plot 
dev.off()
```


## {-}
